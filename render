#!/usr/bin/env bash
set   -e
set   -o pipefail
shopt -s nullglob

# Set default parameter, if none supplied
[[ -n "$IPFS_PATH"    ]] || export IPFS_PATH=/var/lib/ipfs/.ipfs
[[ -n "$GIT_REPO_DIR" ]] || export GIT_REPO_DIR=/home/chris/Programming/repos

function gitVersions() {
    echo "{"
    for D in "$GIT_REPO_DIR"/*.git
    do
        NAME=$(basename "$D" .git)
        REV=$(git ls-remote "$D" HEAD | cut -f1)
        printf '"%s":"%s" ' "$NAME" "$REV"
    done | sed -e 's/ *$//g' -e 's/ /, /g'
    echo "}"
}

REPO_REFS=$(gitVersions)
export REPO_REFS

function build() {
    BASE=$(dirname "$(readlink -f "$0")")
    nix-build --show-trace -A "$1" "$BASE"
}

function doBuild() {
    build wholeSite
}

function addToIpfs() {
    build ipfsHash | tr -d '\n'
}

function pushToIpns() {
    echo "Checking for chriswarbo.net key" 1>&2
    ipfs key list | grep chriswarbonet > /dev/null || {
        echo "Couldn't find key for chriswarbo.net, can't push" 1>&2
        exit 1
    }

    HASHFILE=$(build ipfsHash)
    IPFSHASH=$(cat "$HASHFILE" | tr -d '\n')
    ipfs name publish -k chriswarbonet "$IPFSHASH"
}

# Trick commands into thinking they're run interactively; fixes sudo over ssh
# From http://stackoverflow.com/a/20401674/884682
function faketty() {
    script -qfc "$(printf "%q " "$@")";
}

function pushToWeb() {
    # Update IPNS key
    pushToIpns

    # Get raw files
    DIR=$(doBuild)

    echo "Pushing '$DIR' to Web root" 1>&2
    rsync --update --delete -az --progress -e "ssh -t" \
          --rsync-path="sudo rsync" \
          "$DIR/" chriswarbo.net:/var/www/html
}

printf "Waiting for rendering lock..." 1>&2
(
  flock -x 200
  printf "lock aquired.\n" 1>&2

  case "$1" in
      build)
          doBuild
          ;;

      add)
          addToIpfs
          ;;

      publish)
          pushToIpns
          ;;

      push)
          pushToWeb
          ;;

      *)
          echo "
Usage: $0 <build|add|publish|push>

build: Builds the HTML, git repos, etc. of the site. Outputs a directory
       containing the result (note, this may take a lot of space!).

add: Adds the site to IPFS, outputting the resulting hash. This may take less
     space than performing a build, since we can re-use existing hashes without
     having to make a copy of the files they refer to.

publish: Performs an add, then attempts to publish the result to IPNS.

push: Performs a publish (and hence an add), then attempts to copy the results
      to the chriswarbo.net server over SSH.
          " 1>&2
          exit 1
          ;;
  esac
) 200>/tmp/blog.lock
