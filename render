#! /usr/bin/env nix-shell
#! nix-shell -i bash
mkdir -p rendered; make -j2 -f <(tail -n+4 "$0") "$@"; exit "$?"

# Everything cascades down from index.html, except index.php

index := rendered/index.html

all : $(index) rendered/index.php

# We use Pandoc, PanPipe and PanHandle to render pages

tmp := templates/default.html
pd   = pandoc --filter panpipe --filter panhandle --template $(tmp) -o $2 $1
base = $(notdir $(basename $1))

# Copy css/* as-is

css  := $(wildcard css/*)
rcss := $(addprefix rendered/, $(css))

$(rcss) : css/$(notdir $@)
	mkdir -p rendered/css
	cp css/$(notdir $@) rendered/css/

# Render blog posts

# blog/foo.* -> rendered/blog/foo.html
rendered = $(addprefix rendered/, $(addsuffix .html, $(basename $1)))

# rendered/blog/foo.html -> blog/foo.*
blog_source = $(wildcard $(addsuffix .*, $(addprefix blog/, $(call base, $1))))

posts  := $(wildcard blog/*)
rposts := $(call rendered, $(posts))

$(rposts) : $(call blog_source, $@) $(tmp)
	mkdir -p rendered/blog
	$(call pd, $(call blog_source, $@), $@)

# Top-level pages

contact := rendered/contact.html

$(contact) : contact.md $(tmp)
	$(call pd, contact.md, rendered/contact))

showPost := static/showPost static/showPosts
blog     := rendered/blog.html

$(blog) : blog.md $(rposts) $(tmp) $(showPost)
	$(call pd, blog.md, $(blog))

$(index) : index.md $(contact) $(blog)
	$(call pd, index.md, rendered/index.html)

# Redirects legacy URLs

rendered/index.php : templates/redirect.html
	$(call pd, templates/redirect.html, rendered/index.php)

# Clean up everything

clean :
	rm -rf rendered

.PHONY : clean

#projects := $(wildcard essays/*)

## rendered/projects
## rendered/essays should redirect to redered/projects
## RSS & ATOM
