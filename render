#!/usr/bin/env bash
set   -e
set   -o pipefail
shopt -s nullglob

if command -v ts > /dev/null && ts | grep queued | grep render > /dev/null
then
    echo "Another render is queued, deferring to that"
    exit 0
fi

# We use a lot of recursion, which can overflow the stack, so try increasing it
ulimit -s 100000 || true

function build() {
    echo "Building '$1'" 1>&2
    nix-build --show-trace -A "$1" static/nix
}

function pushToWeb() {
    # Get raw files
    if [[ "$#" -eq 1 ]]
    then
        DIR="$1"
    else
        DIR=$(build wholeSite)
    fi

    DO_PUSH=1 ./pushS3.sh "$DIR"
}

printf "Waiting for rendering lock..." 1>&2
(
  flock -x 200
  echo "lock aquired" 1>&2

  case "$1" in
      page)
          shift
          build "$@"
          ;;

      build)
          build untestedSite
          ;;

      test)
          ./static/checkSource
          build wholeSite
          ;;

      push)
          shift
          pushToWeb "$@"
          ;;

      *)
          echo "
Usage: $0 <build|test|push>

build: Builds the HTML, CSS, etc. of the site. Outputs a directory containing
       the result.

test: Builds the site and runs tests on the result. Outputs a directory
      containing the result.

push: Builds the site and pushes pages to chriswarbo.net
          " 1>&2
          exit 1
          ;;
  esac
) 200>/tmp/blog.lock
